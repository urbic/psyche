<?xml version="1.0"?>
<project name="psyche" default="dist" basedir=".">
	
	<property name="project.name" value="${ant.project.name}"/>
	<property name="src" location="src"/>
	<property name="src.java" location="${src}/java"/>
	<property name="src.jj" location="${src}/jj"/>
	<property name="src.docbook" location="${src}/docbook"/>
	<property name="src.ant" location="${src}/ant"/>
	<property name="src.bin" location="${src}/bin"/>
	<property name="target" location="target"/>
	<property name="target.src.java" location="${target}/src/java"/>
	<property name="target.doc" location="${target}/doc"/>
	<property name="target.doc.javadoc"  location="${target.doc}/javadoc"/>
	<property name="target.classes" location="${target}/classes"/>
	<property name="target.lib"  location="${target}/lib"/>
	<property name="target.bin"  location="${target}/bin"/>
	<property name="target.man"  location="${target}/man"/>
	<property name="target.doc.html" location="${target.doc}/html"/>
	<property name="dest.dir"  location="dest"/>
	<property name="test.file"  location="test.psi"/>
	<property name="xslt.highlight.xslthl.config" location="${src.docbook}/xsl/xslthl/highlighters/xslthl-config.xml"/>
	<property name="home.javadoc.java" location="/usr/share/javadoc/java"/>
	<path id="project.class.path">
		<pathelement path="${target.lib}/${project.name}.jar"/>
		<pathelement path="/usr/share/java/jline.jar"/>
	</path>
	<property file="${src.java}/coneforest/psi/version.properties" prefix="psi"/>
	<property
		name="project.version"
		value="${psi.version.major}.${psi.version.minor}.${psi.version.revision}"
		/>
	
	<import file="${src.ant}/htmldocs.ant"/>
	<import file="${src.ant}/manpages.ant"/>
	<import file="${src.ant}/obs.ant"/>
	<import file="${src.ant}/install.ant"/>

	<target name="compile.jj">
		<mkdir dir="${target.src.java}/coneforest/psi"/>
		<javacc
			target="${src.jj}/coneforest/psi/Parser.jj"
			outputdirectory="${target.src.java}/coneforest/psi"
			javacchome="/usr/share/java"
			unicodeinput="true"
			static="false"
			/>
	</target>

	<target name="compile.java" depends="compile.jj"
			description="compile the source">
		<mkdir dir="${target.classes}"/>
		<javac
			srcdir="${src.java}:${target.src.java}"
			destdir="${target.classes}"
			includeantruntime="false"
			classpathref="project.class.path"
			encoding="UTF-8"
			/>
			<!--sourcepath="${src.java}:${target.src.java}"-->
		<!--copy todir="${target.classes}">
			<fileset dir="${src.java}" includes="**/*.properties"/>
		</copy-->
		<native2ascii
			src="${src.java}"
			encoding="UTF-8"
			dest="${target.classes}"
			includes="**/*.properties"
			ext=".properties"
			/>
	</target>

	<target name="compile" depends="compile.java"/>
	
	<target name="javadoc" depends="compile.jj">
		<javadoc
			sourcepath="${src.java}:${target.src.java}"
			destdir="${target.doc.javadoc}"
			access="public"
			encoding="UTF-8"
			charset="UTF-8"
			>
			<link href="${home.javadoc.java}"/>
		</javadoc>
	</target>

	<target name="jar" depends="compile">
		<jar
			jarfile="${target.lib}/${project.name}-${project.version}.jar"
			basedir="${target.classes}"
			>
			<manifest>
				<attribute name="Main-Class" value="coneforest.psi.Psyche"/>
				<!--attribute name="Class-Path" value="/usr/share/java/regexp.jar"/-->
			</manifest>
			<service
				type="javax.script.ScriptEngineFactory"
				provider="coneforest.psi.engine.PsiScriptEngineFactory"
				/>
		</jar>
		<symlink
			resource="${project.name}-${project.version}.jar"
			link="${target.lib}/${project.name}.jar"
			overwrite="true"
			/>
	</target>

	<target name="clean" description="Clean build directory">
		<delete dir="${target}"/>
	</target>

	<target name="test" depends="jar">
		<java
			classname="coneforest.psi.Psyche"
			fork="true"
			classpathref="project.class.path"
			>
			<arg file="${test.file}"/>
		</java>
	</target>

	<target name="htmldocs" description="Make documentation" depends="css">
		<mkdir dir="${target.doc.html}"/>
		<symlink resource="${src.docbook}/examples" link="examples" overwrite="true"/>
		<!--xslt.lang lang="en"/-->
		<xslt.html.lang lang="ru" base.name="PsiReference"/>
		<copy todir="${target.doc.html}">
			<fileset dir="${src.docbook}" includes="*.png *.svg *.jpeg *.gif *.js"/>
			<fileset dir="${src.docbook}" includes="examples/**" excludes="**/.htaccess"/>
			<fileset dir="${src.docbook}" includes="files/**" excludes="**/.htaccess"/>
			<fileset dir="${src.docbook}" includes="navigation/**"/>
			<fileset dir="${src.docbook}" includes="js/**"/>
		</copy>
		<copy todir="${target.doc.html}" file="${src}/logo/${project.name}-16.png"/>
		<symlink action="delete" link="examples"/>
	</target>
	
	<target name="css" description="Make CSS">
		<mkdir dir="${target.doc.html}"/>
		<dependset>
			<srcfilelist dir="${src.docbook}" files="*.scss"/>
			<targetfileset dir="${target.doc.html}" includes="${project.name}.css"/>
		</dependset>
		<apply executable="sass" dest="${target.doc.html}" parallel="false">
			<arg value="--style"/>
			<arg value="compact"/>
			<!--arg value="-+-load-path"/>
			<arg value="${share.dir}/css"-->
			<srcfile/>
			<targetfile/>
			<fileset dir="${src.docbook}" includes="${project.name}.scss"/>
			<mapper type="glob" from="*.scss" to="*.css"/>
		</apply>
	</target>

	<target name="manpages" description="Make manual pages">
		<copy tofile="${target}/version.ent">
            <string><![CDATA[<?xml version="1.0" encoding="UTF-8"?>
<!ENTITY psiVersion "${project.version}">
]]></string>
        </copy>
		<mkdir dir="${target.doc}"/>
		<symlink resource="${src.docbook}/examples" link="examples" overwrite="true"/>
		<!--xslt.lang lang="en"/-->
		<xslt.manpages.lang lang="en" base.name="PsiManpages"/>
		<symlink action="delete" link="examples"/>
	</target>

	<target name="dist.zip" description="Make zip distribution">
		<symlink resource="." link="${project.name}-${project.version}" overwrite="true"/>
		<zip
			destfile="${target}/${project.name}-${project.version}.zip"
			>
			<fileset
				dir="${project.name}-${project.version}"
				includes="src/** build.xml LICENSE.txt"
				/>
		</zip>
		<symlink action="delete" link="${project.name}-${project.version}"/>
	</target>
	
	<target name="build" description="Build project" depends="jar,htmldocs">
		<copy todir="${target.bin}" file="${src.bin}/${project.name}"/>
		<copy todir="${target.doc}" file="LICENSE.txt"/>
	</target>

</project>
