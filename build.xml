<?xml version="1.0"?>
<project name="psi" default="dist" basedir=".">
	
	<property name="project.name" value="${ant.project.name}"/>
	<property name="src" location="src"/>
	<property name="src.java" location="${src}/java"/>
	<property name="src.jj" location="${src}/jj"/>
	<property name="src.docbook" location="${src}/docbook"/>
	<property name="target" location="target"/>
	<property name="target.src.java" location="${target}/src/java"/>
	<property name="target.javadoc"  location="${target}/javadoc"/>
	<property name="target.doc" location="${target}/doc"/>
	<property name="classes" location="${target}/classes"/>
	<property name="target.lib"  location="${target}/lib"/>
	<property name="test.file"  location="test.psi"/>
	<path id="project.class.path">
		<pathelement path="${target.lib}/${project.name}.jar"/>
		<pathelement path="../xopt/target/lib/xopt.jar"/>
	</path>


	<presetdef name="xslt.preset">
		<xslt
			style="${src.docbook}/xhtml.xsl"
			basedir="${src.docbook}"
			filedirparameter="${src.docbook}"
			force="true"
			>
			<factory name="com.icl.saxon.TransformerFactoryImpl"/>
			<xmlcatalog>
				<catalogpath>
					<pathelement location="${src.docbook}/xmlcatalog"/>
				</catalogpath>
			</xmlcatalog>
			<classpath>
				<pathelement location="/usr/share/java/saxon6.jar"/>
				<pathelement location="/usr/share/java/xml-commons-resolver.jar"/>
				<pathelement location="/usr/share/xml/docbook/stylesheet/nwalsh5/current/extensions/saxon65.jar"/>
				<pathelement location="/usr/share/java/xslthl.jar"/>
			</classpath>
			<param name="highlight.source" expression="1"/>
			<param name="profile.status" expression="${xslt.profile.status}"/>
			<param name="rootid" expression="${xslt.rootid}" if="${xslt.rootid}"/>
			<param name="shortcut.icon" expression="${xslt.shortcut.icon}"/>
			<param name="html.stylesheet" expression="${project.name}.css"/>
			<param name="link.mailto.url" expression="${xslt.link.mailto.url}"/>
			<param name="generate.manifest" expression="0"/>
			<param name="bibliography.numbered" expression="1"/>
			<!--param name="icon.path" expression="img/icons/16x16/${project.name}.png"/-->
			<param name="tablecolumns.extension" expression="${xslt.tablecolumns.extension}"/>
			<param name="table.borders.with.css" expression="${xslt.table.borders.with.css}"/>
			<param name="l10n.gentext.default.language" expression="'ru'"/>
			<param name="bibliography.style" expression="'iso960'"/>
			<param name="draft.mode" expression="'maybe'"/>
			<param name="use.webcounters" expression="${xslt.use.webcounters}"/>
			<param name="highlight.xslthl.config" expression="file://${xslt.highlight.xslthl.config}"/>
			<param name="navig.graphics.path" expression="navigation/"/>
			<param name="navig.graphics.extension" expression=".svg"/>
		</xslt>
	</presetdef>

	<presetdef name="xslt.manpages.preset">
		<xslt
			style="${src.docbook}/manpages.xsl"
			basedir="${src.docbook}"
			filedirparameter="${src.docbook}"
			force="true"
			>
			<factory name="com.icl.saxon.TransformerFactoryImpl"/>
			<xmlcatalog>
				<catalogpath>
					<pathelement location="${src.docbook}/xmlcatalog"/>
				</catalogpath>
			</xmlcatalog>
			<classpath>
				<pathelement location="/usr/share/java/saxon6.jar"/>
				<pathelement location="/usr/share/java/xml-commons-resolver.jar"/>
				<pathelement location="/usr/share/xml/docbook/stylesheet/nwalsh5/current/extensions/saxon65.jar"/>
				<pathelement location="/usr/share/java/xslthl.jar"/>
			</classpath>
			<param name="highlight.source" expression="1"/>
			<param name="profile.status" expression="${xslt.profile.status}"/>
			<param name="rootid" expression="${xslt.rootid}" if="${xslt.rootid}"/>
			<param name="shortcut.icon" expression="${xslt.shortcut.icon}"/>
			<param name="html.stylesheet" expression="${project.name}.css"/>
			<param name="link.mailto.url" expression="${xslt.link.mailto.url}"/>
			<param name="generate.manifest" expression="0"/>
			<param name="bibliography.numbered" expression="1"/>
			<!--param name="icon.path" expression="img/icons/16x16/${project.name}.png"/-->
			<param name="tablecolumns.extension" expression="${xslt.tablecolumns.extension}"/>
			<param name="table.borders.with.css" expression="${xslt.table.borders.with.css}"/>
			<param name="l10n.gentext.default.language" expression="'ru'"/>
			<param name="bibliography.style" expression="'iso960'"/>
			<param name="draft.mode" expression="'maybe'"/>
			<param name="use.webcounters" expression="${xslt.use.webcounters}"/>
			<param name="highlight.xslthl.config" expression="file://${xslt.highlight.xslthl.config}"/>
			<param name="navig.graphics.path" expression="navigation/"/>
			<param name="navig.graphics.extension" expression=".svg"/>
		</xslt>
	</presetdef>

	<macrodef name="xslt.lang">
		<attribute name="base.name"/>
		<attribute name="lang"/>
		<sequential>
			<xslt.preset
				includes="@{base.name}_@{lang}.docbook"
				destdir="${target.doc}"
				>
				<param name="root.filename" expression="@{base.name}_@{lang}"/>
				<param name="html.ext" expression=".xhtml"/>
				<param name="base.dir" expression="${target.doc}"/>
			</xslt.preset>
		</sequential>
	</macrodef>	

	<macrodef name="xslt.manpages.lang">
		<attribute name="base.name"/>
		<attribute name="lang"/>
		<sequential>
			<xslt.manpages.preset
				includes="@{base.name}_@{lang}.docbook"
				destdir="${target.doc}"
				>
				<param name="root.filename" expression="@{base.name}_@{lang}"/>
				<param name="html.ext" expression=".xhtml"/>
				<param name="base.dir" expression="${target.doc}"/>
			</xslt.manpages.preset>
		</sequential>
	</macrodef>	


	<target name="compile.jj">
		<mkdir dir="${target.src.java}/coneforest/psi"/>
		<javacc
			target="${src.jj}/coneforest/psi/Parser.jj"
			outputdirectory="${target.src.java}/coneforest/psi"
			javacchome="/usr/share/java"
			unicodeinput="true"
			static="false"
			/>
	</target>

	<target name="compile.java" depends="compile.jj"
			description="compile the source">
		<mkdir dir="${classes}"/>
		<javac
			srcdir="${src.java}:${target.src.java}"
			destdir="${classes}"
			includeantruntime="false"
			classpathref="project.class.path"
			/>
			<!--sourcepath="${src.java}:${target.src.java}"-->
		<copy todir="${classes}">
			<fileset dir="${src.java}" includes="**/*.xopt"/>
		</copy>
	</target>

	<target name="compile" depends="compile.java"/>
	
	<target name="javadoc" depends="compile.jj">
		<javadoc
			sourcepath="${src.java}:${target.src.java}"
			destdir="${target.javadoc}"
			access="public"
			/>
	</target>

	<target name="jar" depends="compile">
		<jar jarfile="${target.lib}/${ant.project.name}.jar" basedir="${classes}">
			<manifest>
				<attribute name="Main-Class" value="coneforest.psi.Psi"/>
				<!--attribute name="Class-Path" value="/usr/share/java/regexp.jar"/-->
			</manifest>
		</jar>
	</target>

	<target name="clean" description="Clean build directory">
		<delete dir="${target}"/>
	</target>

	<target name="test" depends="jar">
		<java
			classname="coneforest.psi.Psi"
			fork="true"
			classpathref="project.class.path"
			>
			<arg file="${test.file}"/>
		</java>
	</target>

	<target name="doc" description="Make documentation" depends="css">
		<mkdir dir="${target.doc}"/>
		<symlink resource="${src.docbook}/examples" link="examples" overwrite="true"/>
		<!--xslt.lang lang="en"/-->
		<xslt.lang lang="ru" base.name="PSIReference"/>
		<copy todir="${target.doc}">
			<fileset dir="${src.docbook}" includes="*.png *.svg *.jpeg *.gif *.js"/>
			<fileset dir="${src.docbook}" includes="examples/**" excludes="**/.htaccess"/>
			<fileset dir="${src.docbook}" includes="files/**" excludes="**/.htaccess"/>
			<fileset dir="${src.docbook}" includes="navigation/**"/>
			<fileset dir="${src.docbook}" includes="js/**"/>
		</copy>
		<!--copy todir="${build.doc}">
			<fileset dir="${sources.dir}" includes="MathJax4SVG.js"/>
		</copy-->
		<!--symlink resource="../MathJax4SVG.js" link="${site.build.dir}/examples/MathJax4SVG.js" overwrite="true"/-->
		<symlink action="delete" link="examples"/>
	</target>
	
	<target name="css" description="Make CSS">
		<mkdir dir="${target.doc}"/>
		<dependset>
			<srcfilelist dir="${src.docbook}" files="*.scss"/>
			<targetfileset dir="${target.doc}" includes="${project.name}.css"/>
		</dependset>
		<apply executable="sass" dest="${target.doc}" parallel="false">
			<arg value="--style"/>
			<arg value="compact"/>
			<!--arg value="-+-load-path"/>
			<arg value="${share.dir}/css"-->
			<srcfile/>
			<targetfile/>
			<fileset dir="${src.docbook}" includes="${project.name}.scss"/>
			<mapper type="glob" from="*.scss" to="*.css"/>
		</apply>
	</target>

	<target name="manpages" description="Make manual pages">
		<mkdir dir="${target.doc}"/>
		<symlink resource="${src.docbook}/examples" link="examples" overwrite="true"/>
		<!--xslt.lang lang="en"/-->
		<xslt.manpages.lang lang="ru" base.name="psiop"/>
		<symlink action="delete" link="examples"/>
	</target>
	

</project>
